<section class="max-w-5xl mx-auto bg-[var(--color-bg)] text-[var(--color-text)] p-6 rounded-2xl shadow-lg mt-6">
  <h1 class="text-2xl font-semibold mb-2">Crear un nuevo quiz</h1>
  <p class="text-[var(--color-muted)] mb-6">Completa los datos, categor√≠as y a√±ade tus preguntas para comenzar.</p>

  <form [formGroup]="quizForm" (ngSubmit)="submitQuiz()">
    <!-- üü¶ Informaci√≥n general -->
    <div class="mb-8">
      <h2 class="text-lg font-medium mb-3 border-b border-[var(--color-border)] pb-1">Informaci√≥n general</h2>

      <label class="block mb-2 font-medium">T√≠tulo del quiz</label>
      <input
        formControlName="title"
        placeholder="Ej: Conocimientos de Python"
        class="w-full border border-[var(--color-border)] bg-[var(--color-bg-secondary)] rounded-lg px-3 py-2 text-[var(--color-muted)] focus:outline-none focus:ring-2 focus:ring-[var(--color-primary)]"
      />

      <label class="block mt-4 mb-2 font-medium">Descripci√≥n (opcional)</label>
      <textarea
        formControlName="description"
        rows="3"
        placeholder="Describe brevemente el prop√≥sito del quiz"
        class="w-full border border-[var(--color-border)] bg-[var(--color-bg-secondary)] rounded-lg px-3 py-2 text-[var(--color-muted)] focus:outline-none focus:ring-2 focus:ring-[var(--color-primary)]"
      ></textarea>
    </div>

    <!-- üü© Categor√≠as -->
    <div class="mb-10">
      <div class="flex justify-between items-center mb-3">
        <h2 class="text-lg font-medium">Categor√≠as</h2>
        <button
          type="button"
          (click)="addCategory()"
          class="bg-[var(--color-primary)] text-white px-4 py-2 rounded-lg hover:opacity-90 transition"
        >
          + A√±adir categor√≠a
        </button>
      </div>

      <p class="text-sm text-[var(--color-muted)] mb-4">
        Estas categor√≠as ser√°n usadas para an√°lisis multicriterio (TOPSIS).
      </p>

      <div formArrayName="categories" class="flex flex-wrap gap-2">
        @for (cat of categories.controls; track $index; let cIndex = $index) {
          <div [formGroupName]="cIndex" class="flex items-center gap-2 bg-[var(--color-bg-secondary)] border border-[var(--color-border)] rounded-full px-4 py-2">
            <input
              type="text"
              formControlName="name"
              placeholder="Nombre"
              class="bg-transparent text-sm text-[var(--color-muted)] focus:outline-none w-24"
            />
            <input
              type="number"
              formControlName="weight"
              placeholder="Peso"
              step="0.1"
              class="bg-transparent text-sm text-[var(--color-muted)] w-16 focus:outline-none"
            />
            <input type="hidden" formControlName="order_index" />
            <input type="hidden" formControlName="is_active" />
            <button type="button" (click)="removeCategory(cIndex)" class="text-[var(--color-danger)]">
              <mat-icon fontIcon="close" class="text-sm"></mat-icon>
            </button>
          </div>
        }
      </div>
    </div>

    <!-- üüß Preguntas -->
    <div class="mb-8">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-lg font-medium">Preguntas</h2>
        <button
          type="button"
          (click)="addQuestion()"
          class="bg-[var(--color-primary)] text-white px-4 py-2 rounded-lg hover:opacity-90 transition"
        >
          + A√±adir pregunta
        </button>
      </div>

      <div formArrayName="questions">
        @for (q of questions.controls; track $index; let qIndex = $index) {
          <div [formGroupName]="qIndex" class="bg-[var(--color-bg-secondary)] border border-[var(--color-border)] rounded-xl p-4 mb-6">
            <div class="flex justify-between items-center mb-2">
              <span class="font-semibold text-[var(--color-primary)]">Pregunta {{ qIndex + 1 }}</span>
              <button
                type="button"
                (click)="removeQuestion(qIndex)"
                class="text-[var(--color-danger)] hover:underline"
              >
                <mat-icon fontIcon="delete"></mat-icon>
              </button>
            </div>

            <input
              type="text"
              formControlName="question_text"
              placeholder="Escribe la pregunta aqu√≠"
              class="w-full border border-[var(--color-border)] rounded-lg px-3 py-2 mb-3 bg-[var(--color-bg)] text-[var(--color-muted)]"
            />

            <!-- Selector de categor√≠a -->
            <label class="block mb-2 font-medium text-sm">Categor√≠a (opcional)</label>
            <select
              formControlName="category_name"
              class="w-full border border-[var(--color-border)] rounded-lg px-3 py-2 bg-[var(--color-bg)] text-[var(--color-muted)] mb-3"
            >
              <option value="">Sin categor√≠a</option>
              @for (cat of categories.controls; track $index; let ci = $index) {
                <option [value]="categories.at(ci).get('name')?.value">
                  {{ categories.at(ci).get('name')?.value || 'Sin nombre' }}
                </option>
              }
            </select>

            <!-- Subir imagen -->
            <label
              class="block border border-dashed border-[var(--color-border)] rounded-lg text-center py-4 text-sm text-[var(--color-muted)] mb-3 cursor-pointer"
            >
              <input type="file" class="hidden" (change)="onFileSelected($event, qIndex)" />
              <mat-icon fontIcon="image" class="mr-1"></mat-icon> Subir imagen (opcional)
            </label>

            <!-- Tipo de pregunta -->
            <label class="block mb-1 font-medium">Tipo de pregunta</label>
            <select
              formControlName="question_type"
              class="w-full border border-[var(--color-border)] rounded-lg px-3 py-2 bg-[var(--color-bg)] text-[var(--color-muted)]"
            >
              <option value="multiple_choice">Opci√≥n m√∫ltiple</option>
              <option value="true_false">Falso / Verdadero</option>
              <option value="short_answer">Respuesta corta</option>
            </select>

            <!-- Respuestas (solo este bloque est√° dentro del formArrayName="answers") -->
            <div class="space-y-2 mt-4">
              <div formArrayName="answers">
                @for (a of getAnswers(qIndex).controls; track $index; let aIndex = $index) {
                  <div [formGroupName]="aIndex" class="flex items-center gap-2">
                    <input
                      type="text"
                      formControlName="answer_text"
                      class="flex-1 border border-[var(--color-border)] rounded-lg px-3 py-2 bg-[var(--color-bg)] text-[var(--color-muted)]"
                      placeholder="Opci√≥n"
                    />
                    <label class="flex items-center gap-1 text-sm">
                      <input type="checkbox" formControlName="is_correct" class="accent-[var(--color-primary)]" />
                      Correcta
                    </label>
                    <button
                      type="button"
                      (click)="removeAnswer(qIndex, aIndex)"
                      class="text-[var(--color-danger)] hover:underline"
                    >
                      <mat-icon fontIcon="close"></mat-icon>
                    </button>
                  </div>
                }
              </div>

              <button
                type="button"
                (click)="addAnswer(qIndex)"
                class="text-[var(--color-primary)] hover:underline text-sm mt-2"
              >
                + A√±adir opci√≥n
              </button>

              <!-- üïí L√≠mite de tiempo (FUERA del formArrayName="answers") -->
              <div class="border-t border-[var(--color-border)] mt-4 pt-3 flex items-center gap-3">
                <label class="flex items-center gap-2 text-sm text-[var(--color-muted)] cursor-pointer">
                  <input
                    type="checkbox"
                    formControlName="has_time_limit"
                    class="accent-[var(--color-primary)]"
                    (change)="toggleTimeLimit(qIndex)"
                  />
                  Agregar l√≠mite de tiempo (segundos)
                </label>

                @if (q.get('has_time_limit')?.value) {
                  <input
                    type="number"
                    formControlName="time_limit_sec"
                    placeholder="Ej. 20"
                    class="w-24 border border-[var(--color-border)] bg-[var(--color-bg)] text-[var(--color-muted)] rounded-md px-2 py-1 focus:outline-none focus:ring-1 focus:ring-[var(--color-primary)]"
                  />
                }
              </div>
            </div>
          </div>
        }
      </div>
    </div>

    <!-- ‚öôÔ∏è Botones -->
    <div class="flex justify-between items-center pt-4 border-t border-[var(--color-border)]">
      <button
        type="button"
        routerLink="/host/quizzes"
        class="text-[var(--color-primary)] hover:underline font-medium"
      >
        Regresar
      </button>

      <button
        type="submit"
        [disabled]="loading()"
        class="bg-[var(--color-primary)] text-white px-6 py-2 rounded-lg hover:opacity-90 transition"
      >
        {{ loading() ? 'Guardando...' : 'Guardar Quiz' }}
      </button>
    </div>

    @if (error()) {
      <p class="text-[var(--color-danger)] mt-3">{{ error() }}</p>
    }
    @if (success()) {
      <p class="text-green-600 mt-3">‚úÖ Quiz creado correctamente</p>
    }
  </form>
</section>
