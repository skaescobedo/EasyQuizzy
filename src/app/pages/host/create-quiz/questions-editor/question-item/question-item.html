<div [formGroup]="group" class="bg-[var(--color-bg-secondary)] border border-[var(--color-border)] rounded-xl p-4 mb-6">
  <!-- Header con toggle + eliminar -->
  <div class="flex justify-between items-center mb-2">
    <div class="flex items-center gap-2">
      <button
        type="button"
        (click)="toggleCollapse()"
        [attr.aria-expanded]="!collapsed()"
        class="w-8 h-8 rounded-full border border-[var(--color-border)] inline-flex items-center justify-center hover:bg-[var(--color-bg)] transition"
        [title]="collapsed() ? 'Expandir' : 'Contraer'"
      >
        <mat-icon
          fontIcon="expand_more"
          [ngClass]="!collapsed() ? 'rotate-180 transition-transform' : 'transition-transform'">
        </mat-icon>
      </button>

      <span class="font-semibold text-[var(--color-primary)]">Pregunta {{ index + 1 }}</span>

      @if (collapsed()) {
        <span class="text-xs text-[var(--color-muted)] truncate max-w-[420px]">
          ‚Äî {{ questionText || 'Sin t√≠tulo' }}
        </span>
      }
    </div>

    <!-- üî¥ Bot√≥n eliminar (estilo del snippet) -->
    <button
      type="button"
      (click)="remove.emit()"
      class="text-[var(--color-danger)] hover:underline inline-flex items-center gap-1"
      title="Eliminar pregunta">
      <mat-icon fontIcon="delete"></mat-icon>
      Eliminar
    </button>
  </div>

  <!-- Contenido colapsable -->
  @if (!collapsed()) {
    <input
      type="text"
      formControlName="question_text"
      placeholder="Escribe la pregunta aqu√≠"
      class="w-full border border-[var(--color-border)] rounded-lg px-3 py-2 mb-3 bg-[var(--color-bg)] text-[var(--color-muted)]"
    />

    <!-- Selector de categor√≠a -->
    <label class="block mb-2 font-medium text-sm">Categor√≠a (opcional)</label>
    <select
      formControlName="category_name"
      class="w-full border border-[var(--color-border)] rounded-lg px-3 py-2 bg-[var(--color-bg)] text-[var(--color-muted)] mb-3"
    >
      <option value="">Sin categor√≠a</option>
      @for (name of categoryNames; track $index) {
        <option [value]="name">{{ name || 'Sin nombre' }}</option>
      }
    </select>

    <!-- Uploader con preview -->
    <app-image-uploader
      (fileSelected)="onFileSelected($event)"
      [previewUrl]="previewUrl()"
      [filename]="previewName()">
    </app-image-uploader>

    <!-- Tipo -->
    <label class="block mb-1 font-medium">Tipo de pregunta</label>
    <select
      formControlName="question_type"
      class="w-full border border-[var(--color-border)] rounded-lg px-3 py-2 bg-[var(--color-bg)] text-[var(--color-muted)] mb-2"
    >
      <option value="multiple_choice">Opci√≥n m√∫ltiple</option>
      <option value="true_false">Falso / Verdadero</option>
      <option value="short_answer">Respuesta corta</option>
    </select>

    <!-- Bot√≥n IA por pregunta -->
    <div class="flex justify-end mb-2">
      <button type="button"
              (click)="generateExplanation()"
              [disabled]="iaLoading() || !questionText"
              class="text-xs px-3 py-1 rounded-lg border border-[var(--color-border)] hover:bg-[var(--color-bg)]">
        {{ iaLoading() ? 'Generando‚Ä¶' : 'IA: Generar explicaci√≥n' }}
      </button>
    </div>

    <!-- Respuesta corta -->
    @if (type === 'short_answer') {
      <label class="block mb-2 font-medium text-sm">Respuesta correcta (texto)</label>
      <input
        type="text"
        formControlName="correct_text"
        placeholder="Respuesta esperada"
        class="w-full border border-[var(--color-border)] rounded-lg px-3 py-2 bg-[var(--color-bg)] text-[var(--color-muted)] mb-3"
      />
    }

    <!-- Respuestas (MC y TF)
         üìå Importante: en TF ahora S√ç mostramos el toggle de ‚Äúcorrecta‚Äù
         para que puedas elegir si la correcta es ‚ÄúVerdadero‚Äù o ‚ÄúFalso‚Äù. -->
    @if (type !== 'short_answer') {
      <app-answers-editor class="mt-2"
        [formArray]="answersArray"
        [lockAddRemove]="type === 'true_false'"
        [hideCorrectToggle]="false"
        [readonlyText]="type === 'true_false'">
      </app-answers-editor>
    }

    <!-- Explicaci√≥n editable -->
    <label class="block mt-4 mb-2 font-medium text-sm">Explicaci√≥n (editable)</label>
    <textarea
      formControlName="explanation"
      rows="2"
      placeholder="Explicaci√≥n de la respuesta (opcional)"
      class="w-full border border-[var(--color-border)] rounded-lg px-3 py-2 bg-[var(--color-bg)] text-[var(--color-muted)]"
    ></textarea>

    <!-- Tiempo -->
    <app-time-limit-toggle class="mt-4" [group]="group"></app-time-limit-toggle>
  }
</div>
