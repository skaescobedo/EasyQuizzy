<div [formGroup]="group" class="bg-[var(--color-bg-secondary)] border border-[var(--color-border)] rounded-xl p-4 mb-6">
  <!-- Header con toggle -->
  <div class="flex justify-between items-center mb-2">
    <div class="flex items-center gap-2">
      <button
        type="button"
        (click)="toggleCollapse()"
        [attr.aria-expanded]="!collapsed()"
        class="w-8 h-8 flex items-center justify-center rounded-md border border-[var(--color-border)] hover:bg-[var(--color-bg)] transition"
        title="{{ collapsed() ? 'Expandir' : 'Colapsar' }}"
      >
        <mat-icon [fontIcon]="collapsed() ? 'keyboard_arrow_right' : 'keyboard_arrow_down'"></mat-icon>
      </button>

      <span class="font-semibold text-[var(--color-primary)]">Pregunta {{ index + 1 }}</span>

      @if (collapsed()) {
        <span class="text-xs text-[var(--color-muted)] truncate max-w-[420px]">
          — {{ questionText || 'Sin título' }}
        </span>
      }
    </div>

    <button type="button" (click)="remove.emit()" class="text-[var(--color-danger)] hover:underline">
      <mat-icon fontIcon="delete"></mat-icon>
    </button>
  </div>

  <!-- Contenido colapsable -->
  @if (!collapsed()) {
    <input
      type="text"
      formControlName="question_text"
      placeholder="Escribe la pregunta aquí"
      class="w-full border border-[var(--color-border)] rounded-lg px-3 py-2 mb-3 bg-[var(--color-bg)] text-[var(--color-muted)]"
    />

    <!-- Selector de categoría -->
    <label class="block mb-2 font-medium text-sm">Categoría (opcional)</label>
    <select
      formControlName="category_name"
      class="w-full border border-[var(--color-border)] rounded-lg px-3 py-2 bg-[var(--color-bg)] text-[var(--color-muted)] mb-3"
    >
      <option value="">Sin categoría</option>
      @for (name of categoryNames; track $index) {
        <option [value]="name">{{ name || 'Sin nombre' }}</option>
      }
    </select>

    <!-- Uploader -->
    <!-- Uploader con preview -->
    <app-image-uploader
      (fileSelected)="onFileSelected($event)"
      [previewUrl]="previewUrl()"
      [filename]="previewName()">
    </app-image-uploader>


    <!-- Tipo -->
    <label class="block mb-1 font-medium">Tipo de pregunta</label>
    <select
      formControlName="question_type"
      class="w-full border border-[var(--color-border)] rounded-lg px-3 py-2 bg-[var(--color-bg)] text-[var(--color-muted)] mb-2"
    >
      <option value="multiple_choice">Opción múltiple</option>
      <option value="true_false">Falso / Verdadero</option>
      <option value="short_answer">Respuesta corta</option>
    </select>

    <!-- Respuesta corta -->
    @if (type === 'short_answer') {
      <label class="block mb-2 font-medium text-sm">Respuesta correcta (texto)</label>
      <input
        type="text"
        formControlName="correct_text"
        placeholder="Respuesta esperada"
        class="w-full border border-[var(--color-border)] rounded-lg px-3 py-2 bg-[var(--color-bg)] text-[var(--color-muted)] mb-3"
      />
    }

    <!-- Respuestas (MC y TF) -->
    @if (type !== 'short_answer') {
      <app-answers-editor class="mt-2"
        [formArray]="answersArray"
        [lockAddRemove]="type === 'true_false'"
        [hideCorrectToggle]="type === 'true_false'"
        [readonlyText]="type === 'true_false'">
      </app-answers-editor>
    }


    <!-- Tiempo -->
    <app-time-limit-toggle class="mt-4" [group]="group"></app-time-limit-toggle>
  }
</div>
