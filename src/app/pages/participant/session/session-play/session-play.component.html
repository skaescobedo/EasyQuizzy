<section
  class="min-h-screen flex flex-col items-center justify-center p-6 
         bg-gradient-to-br from-[var(--color-bg)] to-[#93c5fd] via-[#93c5fd]"
>
  @if (currentQuestion(); as q) {
    <!-- ========================================================= -->
    <!-- ðŸ”¹ JUGANDO PREGUNTAS -->
    <!-- ========================================================= -->
    @if (!quizEnded()) {
      <div
        class="w-full max-w-3xl bg-[var(--color-bg)] shadow-xl rounded-2xl p-8 
               border border-[var(--color-border)] transition-all"
      >
        <!-- Encabezado -->
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-2xl font-extrabold text-[var(--color-text)]">
            Pregunta {{ session.currentQuestionIndex() + 1 }}
          </h2>

          <div class="flex items-center gap-2 text-[var(--color-danger)] font-semibold">
            <span class="material-icons">timer</span>
            <span>
              @if (timeLeft() > 0) {
                {{ timeLeft() | number: '2.0' }}s
              } @else {
                <span>âˆž</span>
              }
            </span>
          </div>
        </div>

        <!-- Texto de la pregunta -->
        <h1 class="text-3xl font-bold mb-6 text-center text-[var(--color-text)]">
          {{ q.question_text }}
        </h1>

        <!-- Imagen (si existe) -->
        @if (q.image_url) {
          <img
            [src]="q.image_url"
            alt="imagen"
            class="w-full max-h-64 object-contain rounded-xl mb-6 mx-auto border border-[var(--color-border)]"
          />
        }

        <!-- OPCIONES o INPUT -->
        <div class="mb-6">
          @if (q.question_type !== 'short_answer') {
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
              @for (ans of q.answers; track ans.answer_id) {
                <button
                  (click)="selectAnswer(ans.answer_id)"
                  class="p-4 text-lg font-medium rounded-xl border-transparent transition-all duration-200
                        bg-[var(--color-bg-secondary)] text-[var(--color-text)]
                        hover:scale-[1.02]
                        disabled:pointer-events-none disabled:cursor-default"
                  [class.bg-[var(--color-primary)]]="!showFeedback() && selectedAnswer() === ans.answer_id"
                  [class.bg-green-500]="showFeedback() && isCorrectAnswer(ans.answer_id)"
                  [class.bg-red-500]="
                    showFeedback() && selectedAnswer() === ans.answer_id && !isCorrectAnswer(ans.answer_id)
                  "
                  [class.text-white]="
                    (selectedAnswer() === ans.answer_id && !showFeedback()) ||
                    (showFeedback() && isCorrectAnswer(ans.answer_id)) ||
                    (showFeedback() && selectedAnswer() === ans.answer_id && !isCorrectAnswer(ans.answer_id))
                  "
                  [disabled]="isSubmitted() || showFeedback()"
                >
                  {{ ans.answer_text }}
                </button>
              }
            </div>
          }

          @if (q.question_type === 'short_answer') {
            <div class="flex flex-col items-center gap-4">
              <input
                type="text"
                [(ngModel)]="shortAnswer"
                [disabled]="isSubmitted() || showFeedback()"
                placeholder="Escribe tu respuesta..."
                class="w-full border-2 border-[var(--color-border)] rounded-xl px-4 py-3 text-lg text-[var(--color-text)]
                      bg-[var(--color-bg-secondary)] focus:border-[var(--color-primary)] outline-none transition"
              />
            </div>
          }
        </div>

        <!-- ðŸš€ BotÃ³n de envÃ­o -->
        <div class="flex flex-col items-center gap-4">
          @if (!showFeedback()) {
            <button
              (click)="submit()"
              [disabled]="
                isSubmitted() ||
                (q.question_type !== 'short_answer' && !selectedAnswer()) ||
                (q.question_type === 'short_answer' && !shortAnswer)
              "
              class="bg-[var(--color-primary)] hover:bg-[var(--color-primary-hover)] 
                     text-white px-8 py-3 rounded-xl font-semibold shadow-md transition cursor-pointer
                     disabled:opacity-60 disabled:cursor-default"
            >
              Enviar respuesta
            </button>
          }

          @if (isSubmitted() && !showFeedback()) {
            <div class="flex items-center gap-2 text-[var(--color-success)] font-semibold">
              <span class="material-icons">check_circle</span>
              <span>Respuesta enviada</span>
            </div>
          }
        </div>

        <!-- ðŸ”¹ ExplicaciÃ³n y respuesta correcta -->
        @if (showFeedback() && (q.explanation || q.correct_text)) {
          <div class="bg-[var(--color-bg-secondary)] mt-6 p-4 rounded-xl text-[var(--color-text)] shadow-inner">
            @if (q.question_type === 'short_answer' && q.correct_text) {
              <div class="flex flex-col mb-2">
                <p class="font-semibold mb-2 flex items-center gap-2 text-[var(--color-primary)]">
                  <span class="material-icons">check_circle</span>
                  Respuesta correcta
                </p>
                <p class="text-base font-medium bg-white/50 px-3 py-2 rounded-lg border border-[var(--color-border)]">
                  {{ q.correct_text }}
                </p>
              </div>
            }
            <p class="font-semibold mb-2 flex items-center gap-2">
              <span class="material-icons text-[var(--color-primary)]">info</span>
              ExplicaciÃ³n
            </p>
            <p class="text-sm leading-relaxed">{{ q.explanation }}</p>
          </div>
        }

        <!-- Avatar -->
        <div class="mt-10 flex justify-center items-center gap-4 text-[var(--color-muted)] text-sm">
          <img
            [src]="getAvatar()"
            class="w-10 h-10 rounded-full border border-[var(--color-border)] shadow-sm"
            alt="avatar"
          />
          <span>{{ session.nickname() || 'TÃº' }}</span>
        </div>
      </div>

    } @else {
      <!-- ========================================================= -->
      <!-- ðŸ† RESULTADOS FINALES DEL PARTICIPANTE -->
      <!-- ========================================================= -->
      <div
        class="w-full max-w-2xl bg-[var(--color-bg)] shadow-xl rounded-2xl p-8 
               border border-[var(--color-border)] transition-all text-center"
      >
        <h2 class="text-3xl font-bold text-[var(--color-primary)] mb-6 flex items-center justify-center gap-2">
          <span class="material-icons text-[var(--color-primary)] text-4xl">emoji_events</span>
          Â¡Quiz finalizado!
        </h2>

        <p class="text-lg text-[var(--color-text)] mb-4">
          Tu puntaje total es:
        </p>
        <p class="text-5xl font-extrabold text-[var(--color-primary)] mb-8">
          {{ totalScore() }} pts
        </p>

        <!-- Tabla resumida -->
<!-- Tabla resumida -->
<ul
  class="divide-y divide-[var(--color-border)] bg-[var(--color-bg-secondary)] rounded-xl shadow-inner mb-6"
>
  @for (p of rankedParticipants(); track p.nickname; let i = $index) {
    <li class="py-3 px-6 flex justify-between items-center">
      <div class="flex items-center gap-3">
        <span class="font-bold w-6 text-[var(--color-text)] text-center">
          {{ i + 1 }}.
        </span>

        <!-- Trofeos solo para los 3 primeros -->
        @if (i === 0) {
          <span class="material-icons text-yellow-500">emoji_events</span>
        } @else if (i === 1) {
          <span class="material-icons text-gray-400">emoji_events</span>
        } @else if (i === 2) {
          <span class="material-icons text-amber-700">emoji_events</span>
        }

        <img
          [src]="p.avatar_url || 'https://cdn-icons-png.flaticon.com/512/149/149071.png'"
          class="w-10 h-10 rounded-full border border-[var(--color-border)] shadow-sm"
        />
        <span class="font-semibold text-[var(--color-text)]">{{ p.nickname }}</span>
      </div>

      <span class="font-bold text-[var(--color-primary)]">
        {{ p.score || 0 }}
      </span>
    </li>
  }
</ul>

        <!-- Botones -->
        <div class="flex flex-col gap-3 mt-6">
          <div class="flex flex-col sm:flex-row justify-center gap-3">
            <button
              (click)="reloadQuiz()"
              class="bg-[var(--color-primary)] cursor-pointer hover:bg-[var(--color-primary-hover)] 
                     text-white px-6 py-3 rounded-xl font-semibold shadow-md transition flex items-center justify-center gap-2"
            >
              <span class="material-icons">replay</span>
              Unirme a otro quiz
            </button>

            <button
              (click)="goHome()"
              class="bg-[var(--color-success)] cursor-pointer hover:bg-green-600 
                     text-white px-6 py-3 rounded-xl font-semibold shadow-md transition flex items-center justify-center gap-2"
            >
              <span class="material-icons">home</span>
              Ir a EasyQuizzy
            </button>
          </div>

          <!-- Input de nuevo cÃ³digo -->
          @if (showJoinInput()) {
            <div class="mt-4 flex flex-col sm:flex-row gap-3 justify-center items-center">
              <input
                [(ngModel)]="joinCode"
                placeholder="CÃ³digo del nuevo quiz"
                maxlength="6"
                class="border-2 border-[var(--color-border)] rounded-xl px-4 py-2 w-60 text-center text-[var(--color-text)]
                       bg-[var(--color-bg-secondary)] focus:border-[var(--color-primary)] outline-none transition"
              />
              <button
                (click)="joinNewQuiz()"
                class="bg-[var(--color-primary)] hover:bg-[var(--color-primary-hover)] text-white px-4 py-2 rounded-xl font-semibold shadow-md transition"
              >
                Unirme
              </button>
            </div>
          }
        </div>
      </div>
    }
  } @else {
    <div class="text-center mt-20 text-[var(--color-text)] animate-pulse">
      Esperando inicio del quiz...
    </div>
  }
</section>
