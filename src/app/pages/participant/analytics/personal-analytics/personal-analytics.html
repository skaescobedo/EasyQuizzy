<section class="max-w-4xl mx-auto p-6">
  <!-- Header -->
  <div class="mb-6">
    @if (analytics()) {
      <h1 class="text-2xl font-semibold text-[var(--color-text)] mb-2">
        Tu desempe√±o - {{ analytics()!.session_info.quiz_title }}
      </h1>
      <p class="text-[var(--color-muted)]">Revisa tus respuestas y aprende de tus errores</p>
    }
  </div>

  <!-- Loading -->
  @if (loading()) {
    <div class="flex items-center justify-center py-20">
      <div class="text-center">
        <div class="inline-block animate-spin rounded-full h-12 w-12 border-4 border-solid border-[var(--color-primary)] border-r-transparent"></div>
        <p class="mt-4 text-[var(--color-muted)]">Cargando tus resultados...</p>
      </div>
    </div>
  }

  <!-- Error -->
  @if (error() && !loading()) {
    <div class="p-4 border border-[var(--color-border)] rounded-xl text-[var(--color-danger)] bg-red-50 dark:bg-red-900/20">
      {{ error() }}
    </div>
  }

  <!-- Analytics -->
  @if (!loading() && !error() && analytics() && analytics()!.personal_stats) {
    <div>
      <!-- üéØ Tarjeta de resumen personal -->
      <div class="bg-[var(--color-bg-secondary)] border border-[var(--color-border)] rounded-xl p-6 mb-8">
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
          <div>
            <p class="text-3xl font-bold text-[var(--color-primary)]">
              {{ analytics()!.personal_stats!.total_score }}/{{ analytics()!.personal_stats!.max_possible_score }}
            </p>
            <p class="text-sm text-[var(--color-muted)] mt-1">Puntaje Bruto</p>
          </div>

          <!-- üéØ NUEVO: Mostrar score TOPSIS si existe -->
          @if (myTopsisData()) {
            <div>
              <p class="text-3xl font-bold text-[var(--color-primary)]">
                {{ myTopsisData()!.topsis_score }}%
              </p>
              <p class="text-sm text-[var(--color-muted)] mt-1">Score Ponderado</p>
            </div>
          }

          <div>
            <p class="text-3xl font-bold text-[var(--color-primary)]">
              {{ analytics()!.personal_stats!.accuracy_rate | number: '1.0-0' }}%
            </p>
            <p class="text-sm text-[var(--color-muted)] mt-1">Precisi√≥n</p>
          </div>

          <div>
            <p class="text-3xl font-bold text-[var(--color-primary)]">
              {{ formatTime(analytics()!.personal_stats!.avg_response_time_ms) }}
            </p>
            <p class="text-sm text-[var(--color-muted)] mt-1">Promedio/pregunta</p>
          </div>
        </div>
      </div>

      <!-- üéØ NUEVA SECCI√ìN: Desempe√±o por categor√≠a -->
      @if (myTopsisData(); as myData) {
        <div class="mb-8">
          <h2 class="text-xl font-semibold text-[var(--color-text)] mb-4 flex items-center gap-2">
            <mat-icon fontIcon="analytics" class="text-[var(--color-primary)]"></mat-icon>
            Tu desempe√±o por categor√≠a
          </h2>

          <div class="bg-[var(--color-bg-secondary)] p-4 rounded-xl border border-[var(--color-border)] mb-4">
            <p class="text-sm text-[var(--color-muted)] italic">
              ‚ÑπÔ∏è Las categor√≠as tienen diferentes pesos seg√∫n su importancia en el quiz
            </p>
          </div>

          <div class="grid grid-cols-1 gap-4">
            @for (catEntry of getCategoryEntries(); track catEntry[0]) {
              <div class="bg-[var(--color-bg)] border border-[var(--color-border)] rounded-xl p-5 shadow-sm">
                <!-- Header de categor√≠a -->
                <div class="flex justify-between items-start mb-3">
                  <h3 class="text-lg font-semibold text-[var(--color-text)]">
                    {{ catEntry[0] }}
                  </h3>
                  <span class="px-3 py-1 rounded-lg text-sm font-semibold bg-[var(--color-primary)] text-white">
                    Peso: {{ (catEntry[1].weight * 100).toFixed(0) }}%
                  </span>
                </div>

                <!-- Estad√≠sticas -->
                <div class="mb-3">
                  <div class="flex justify-between items-center mb-2">
                    <span class="text-sm text-[var(--color-muted)]">
                      {{ catEntry[1].correct }}/{{ catEntry[1].total }} preguntas correctas
                    </span>
                    <span class="text-lg font-bold" [class]="getCategoryTextColor(catEntry[1].score)">
                      {{ catEntry[1].score }}%
                    </span>
                  </div>

                  <!-- Barra de progreso -->
                  <div class="w-full bg-[var(--color-bg-secondary)] rounded-full h-3">
                    <div
                      [class]="getCategoryColor(catEntry[1].score)"
                      [style.width.%]="catEntry[1].score"
                      class="h-3 rounded-full transition-all duration-500 flex items-center justify-end pr-2"
                    >
                      @if (catEntry[1].score > 15) {
                        <span class="text-xs font-bold text-white">
                          {{ catEntry[1].score }}%
                        </span>
                      }
                    </div>
                  </div>
                </div>

                <!-- Contribuci√≥n al score -->
                <div class="bg-[var(--color-bg-secondary)] rounded-lg p-3 mb-3">
                  <p class="text-sm text-[var(--color-muted)]">
                    üí° <strong>Contribuci√≥n al score final:</strong> 
                    {{ (catEntry[1].score * catEntry[1].weight).toFixed(1) }} puntos
                  </p>
                </div>

                <!-- Mensaje de feedback -->
                <div class="flex items-start gap-2">
                  <mat-icon 
                    [fontIcon]="catEntry[1].score >= 80 ? 'check_circle' : 'info'"
                    [ngClass]="getCategoryTextColor(catEntry[1].score)"
                    class="text-xl mt-0.5"
                  ></mat-icon>
                  <p class="text-sm" [class]="getCategoryTextColor(catEntry[1].score)">
                    {{ getCategoryMessage(catEntry[1].score) }}
                  </p>
                </div>
              </div>
            }
          </div>
        </div>

        <!-- üí° Recomendaciones personalizadas -->
        <div class="bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-xl p-5 mb-8">
          <div class="flex items-start gap-3">
            <mat-icon fontIcon="lightbulb" class="text-yellow-600 dark:text-yellow-500 text-2xl"></mat-icon>
            <div class="flex-1">
              <h3 class="font-semibold text-lg text-[var(--color-text)] mb-3">
                üí° Recomendaciones personalizadas
              </h3>

              <ul class="space-y-2 text-sm text-[var(--color-muted)]">
                @for (catEntry of getCategoryEntries(); track catEntry[0]) {
                  @if (catEntry[1].score < 60 && catEntry[1].weight >= 0.2) {
                    <li class="flex items-start gap-2">
                      <mat-icon fontIcon="arrow_right" class="text-yellow-600 text-base mt-0.5"></mat-icon>
                      <span>
                        Tu desempe√±o en <strong>{{ catEntry[0] }}</strong> 
                        ({{ (catEntry[1].weight * 100).toFixed(0) }}% del quiz) est√° en 
                        {{ catEntry[1].score }}%. 
                        Te recomendamos repasar este tema.
                      </span>
                    </li>
                  }
                }

                @for (catEntry of getCategoryEntries(); track catEntry[0]) {
                  @if (catEntry[1].score >= 90) {
                    <li class="flex items-start gap-2">
                      <mat-icon fontIcon="check" class="text-green-600 text-base mt-0.5"></mat-icon>
                      <span>
                        ¬°Excelente trabajo en <strong>{{ catEntry[0] }}</strong>! 
                        Sigue as√≠.
                      </span>
                    </li>
                  }
                }
              </ul>
            </div>
          </div>
        </div>
      }

      <!-- üìù Repaso de respuestas -->
      <div class="mb-8">
        <h2 class="text-xl font-semibold text-[var(--color-text)] mb-4 flex items-center gap-2">
          <mat-icon fontIcon="quiz" class="text-[var(--color-primary)]"></mat-icon>
          Repaso de tus respuestas
        </h2>

        @if (!analytics()!.personal_breakdown || analytics()!.personal_breakdown!.length === 0) {
          <p class="text-[var(--color-muted)] text-center py-10">
            No hay datos de respuestas disponibles.
          </p>
        } @else {
          <div class="space-y-4">
            @for (item of analytics()!.personal_breakdown; track item.question_id) {
              <div class="bg-[var(--color-bg)] border border-[var(--color-border)] rounded-xl p-5">
                <!-- Header de pregunta -->
                <div class="flex items-start gap-3 mb-3">
                  <mat-icon
                    [fontIcon]="getAnswerIcon(item.is_correct)"
                    [ngClass]="getAnswerIconClass(item.is_correct)"
                    class="text-2xl mt-1"
                  ></mat-icon>

                  <div class="flex-1">
                    <div class="flex items-start justify-between gap-4">
                      <div>
                        <h4 class="font-semibold text-[var(--color-text)] mb-1">
                          Pregunta {{ item.order_index }}
                        </h4>
                        <p class="text-[var(--color-text)]">{{ item.question_text }}</p>
                      </div>

                      <span class="text-sm text-[var(--color-muted)] whitespace-nowrap">
                        {{ formatTime(item.response_time_ms) }}
                      </span>
                    </div>
                  </div>
                </div>

                <!-- Respuestas -->
                <div class="ml-11 space-y-3">
                  <!-- Tu respuesta -->
                  <div class="bg-[var(--color-bg-secondary)] rounded-lg p-3 border border-[var(--color-border)]">
                    <p class="text-sm font-medium text-[var(--color-muted)] mb-1">Tu respuesta:</p>
                    <p class="text-[var(--color-text)]" [ngClass]="item.is_correct ? 'text-green-700 dark:text-green-400' : 'text-red-700 dark:text-red-400'">
                      {{ item.your_answer }}
                    </p>
                  </div>

                  <!-- Respuesta correcta (si fall√≥) -->
                  @if (!item.is_correct) {
                    <div class="bg-green-50 dark:bg-green-900/20 rounded-lg p-3 border border-green-200 dark:border-green-800">
                      <p class="text-sm font-medium text-green-700 dark:text-green-400 mb-1">Respuesta correcta:</p>
                      <p class="text-green-800 dark:text-green-300">{{ item.correct_answer }}</p>
                    </div>
                  }

                  <!-- Explicaci√≥n -->
                  @if (item.explanation) {
                    <div class="bg-blue-50 dark:bg-blue-900/20 rounded-lg p-3 border border-blue-200 dark:border-blue-800">
                      <p class="text-sm font-medium text-blue-700 dark:text-blue-400 mb-1 flex items-center gap-1">
                        <mat-icon fontIcon="lightbulb" class="text-base"></mat-icon>
                        Explicaci√≥n:
                      </p>
                      <p class="text-blue-800 dark:text-blue-300 text-sm">{{ item.explanation }}</p>
                    </div>
                  }
                </div>
              </div>
            }
          </div>
        }
      </div>

      <!-- Botones de acci√≥n -->
      <div class="flex flex-col sm:flex-row justify-center gap-3 mt-8">
        <button
          (click)="retryQuiz()"
          class="bg-[var(--color-primary)] hover:bg-[var(--color-primary-hover)] text-white px-6 py-3 rounded-xl font-semibold shadow-md transition inline-flex items-center justify-center gap-2"
        >
          <mat-icon fontIcon="replay"></mat-icon>
          Volver a intentarlo
        </button>

        <button
          (click)="goHome()"
          class="bg-gray-600 hover:bg-gray-700 text-white px-6 py-3 rounded-xl font-semibold shadow-md transition inline-flex items-center justify-center gap-2"
        >
          <mat-icon fontIcon="home"></mat-icon>
          Ir a inicio
        </button>
      </div>
    </div>
  }
</section>